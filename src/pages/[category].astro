---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Generate static paths for all categories
export async function getStaticPaths() {
  const response = await fetch('https://mintdealsbackend-production.up.railway.app/api/categories?populate=*');
  const data = await response.json();
  const categories = data?.data || [];

  return categories.map(cat => ({
    params: { category: cat.slug },
  }));
}

const { category } = Astro.params;

// Fetch category data
let categoryName = 'Category';
let categorySlug = category;
let categoryImageUrl = null;
let categoryDescription = '';

try {
  const categoryResponse = await fetch(`https://mintdealsbackend-production.up.railway.app/api/categories?filters[slug][$eq]=${category}&populate=*`);

  if (categoryResponse.ok) {
    const categoryDataResponse = await categoryResponse.json();
    if (categoryDataResponse?.data?.length > 0) {
      const categoryData = categoryDataResponse.data[0];
      categoryName = categoryData.Name || 'Category';
      categorySlug = categoryData.slug || category;
      categoryDescription = categoryData.Discription || '';
      categoryImageUrl = categoryData?.image?.url || null;
    } else {
      return Astro.redirect('/404', 404);
    }
  } else {
    return Astro.redirect('/404', 404);
  }
} catch (error) {
  console.error('Error fetching category:', error);
  return Astro.redirect('/404', 404);
}

// Fetch products for this category
let products = [];

try {
  const response = await fetch(`https://mintdealsbackend-production.up.railway.app/api/products?populate=*&filters[category][slug][$eq]=${categorySlug}&pagination[pageSize]=100`);

  if (response.ok) {
    const data = await response.json();
    products = data?.data || [];
  }
} catch (error) {
  console.error('Error fetching products:', error);
}
---

<Layout title={`${categoryName} - Cannabis Products | Mint Deals`} description={`Browse ${categoryName} cannabis products and find the best deals from dispensaries.`}>
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Breadcrumb Navigation -->
    <div class="py-4 bg-black bg-opacity-70">
      <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <nav class="flex" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm">
            <li>
              <a href="/" class="text-gray-400 hover:text-yellow-400">Home</a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 mx-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <a href="/categories" class="text-gray-400 hover:text-yellow-400">Categories</a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 mx-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-yellow-400 font-medium">{categoryName}</span>
            </li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Hero Section -->
    <div class="hero-section text-white">
      <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <div class="text-center">
          <!-- Category Hero Image -->
          {categoryImageUrl && (
            <div class="mb-8">
              <img
                src={`https://mintdealsbackend-production.up.railway.app${categoryImageUrl}`}
                alt={categoryName}
                class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-yellow-400/30 drop-shadow-2xl"
              />
            </div>
          )}

          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4 text-white drop-shadow-2xl">
            {categoryName}
          </h1>

          {categoryDescription && (
            <p class="text-xl lg:text-2xl text-yellow-400 max-w-3xl mx-auto drop-shadow-lg">
              {categoryDescription}
            </p>
          )}
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto py-12 bg-black bg-opacity-90 text-white">
      <!-- Rich Text Content Section (Client-side loaded) -->
      <div class="mt-16">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-yellow-400 mb-8 text-center drop-shadow-lg">
            Learn About {categoryName}
          </h2>

          {categoryImageUrl && (
            <div class="mb-8">
              <img
                src={`https://mintdealsbackend-production.up.railway.app${categoryImageUrl}`}
                alt={categoryName}
                class="w-full h-64 md:h-80 object-cover rounded-lg shadow-lg"
              />
            </div>
          )}

          <div class="bg-black bg-opacity-90 p-8 md:p-12 rounded-lg shadow-2xl border-2 border-yellow-400 overflow-hidden">
            <div id="richTextContent" data-slug={categorySlug} class="rich-text-content">
              <p class="text-center text-gray-400">Loading content...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Related Categories -->
      <div class="mt-16">
        <h2 class="text-2xl font-bold text-white mb-8 text-center">
          Explore Other Categories
        </h2>
        <div class="flex justify-center">
          <a
            href="/categories"
            class="inline-flex items-center px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-black rounded-lg font-medium transition-colors"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Browse All Categories
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Client-side script to load RichText -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('richTextContent');
      const slug = container?.getAttribute('data-slug');

      if (!container || !slug) {
        console.error('Missing container or slug');
        return;
      }

      try {
        const response = await fetch(`https://mintdealsbackend-production.up.railway.app/api/categories?filters[slug][$eq]=${slug}&populate=*`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const richText = data?.data?.[0]?.RichText;

        if (richText && typeof richText === 'string') {
          container.innerHTML = richText;
        } else {
          container.innerHTML = '<p class="text-gray-400">No content available.</p>';
        }
      } catch (error) {
        console.error('Failed to load rich text:', error);
        container.innerHTML = '<p class="text-red-400">Error loading content.</p>';
      }
    });
  </script>
</Layout>

<style>
  body {
    margin: 0;
    padding: 0;
  }

  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }

  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }

  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }

  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }

  .hero-section {
    min-height: 10vh; /* 25% of desktop (40vh) */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 0;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 40vh;
      padding: 2rem 0;
    }
  }

  /* Rich Text Content Styling */
  .rich-text-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    width: 100%;
  }

  .rich-text-content > :global(*) {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
  }

  .rich-text-content :global(div),
  .rich-text-content :global(section),
  .rich-text-content :global(article) {
    max-width: 100%;
    overflow: hidden;
  }

  .rich-text-content :global(h1),
  .rich-text-content :global(h2),
  .rich-text-content :global(h3),
  .rich-text-content :global(h4),
  .rich-text-content :global(h5),
  .rich-text-content :global(h6) {
    font-weight: 700;
    color: #fbbf24;
    margin-top: 1.5em;
    margin-bottom: 0.75em;
    line-height: 1.3;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .rich-text-content :global(h1) { font-size: 2.25em; }
  .rich-text-content :global(h2) { font-size: 1.875em; }
  .rich-text-content :global(h3) { font-size: 1.5em; }
  .rich-text-content :global(h4) { font-size: 1.25em; }
  .rich-text-content :global(h5) { font-size: 1.125em; }
  .rich-text-content :global(h6) { font-size: 1em; }

  .rich-text-content :global(p) {
    margin-bottom: 1.25em;
    line-height: 1.75;
    color: #ffffff;
    font-size: 1.125rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .rich-text-content :global(strong),
  .rich-text-content :global(b) {
    font-weight: 700;
    color: #fff;
  }

  .rich-text-content :global(em),
  .rich-text-content :global(i) {
    font-style: italic;
    color: #ffffff;
  }

  .rich-text-content :global(ul),
  .rich-text-content :global(ol) {
    margin-bottom: 1.25em;
    padding-left: 1.75em;
    color: #ffffff;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .rich-text-content :global(ul) {
    list-style-type: disc;
  }

  .rich-text-content :global(ol) {
    list-style-type: decimal;
  }

  .rich-text-content :global(li) {
    margin-bottom: 0.5em;
    line-height: 1.75;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    color: #ffffff;
  }

  .rich-text-content :global(li)::marker {
    color: #fbbf24;
  }

  .rich-text-content :global(a) {
    color: #60a5fa;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .rich-text-content :global(a:hover) {
    color: #93c5fd;
  }

  .rich-text-content :global(blockquote) {
    border-left: 4px solid #10b981;
    padding-left: 1.5em;
    margin: 1.5em 0;
    font-style: italic;
    color: #9ca3af;
  }

  .rich-text-content :global(code) {
    background-color: #1f2937;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875em;
    color: #fbbf24;
  }

  .rich-text-content :global(pre) {
    background-color: #1f2937;
    padding: 1em;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5em 0;
  }

  .rich-text-content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }

  .rich-text-content :global(table) {
    display: block;
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    border-collapse: collapse;
    margin: 1.5em 0;
    -webkit-overflow-scrolling: touch;
  }

  .rich-text-content :global(table) :global(tbody),
  .rich-text-content :global(table) :global(thead) {
    display: table;
    width: 100%;
    table-layout: fixed;
  }

  .rich-text-content :global(th),
  .rich-text-content :global(td) {
    border: 1px solid #374151;
    padding: 0.75em;
    text-align: left;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .rich-text-content :global(th) {
    background-color: #1f2937;
    font-weight: 700;
    color: #fbbf24;
  }

  .rich-text-content :global(td) {
    color: #ffffff;
  }

  .rich-text-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1.5em 0;
  }

  .rich-text-content :global(hr) {
    border: 0;
    border-top: 2px solid #374151;
    margin: 2em 0;
  }
</style>
