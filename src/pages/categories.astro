---
import Layout from '../layouts/Layout.astro';

// Fetch categories from Railway Strapi API
let categoriesData = [];
let apiError = null;

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

// Category icon mapping
function getCategoryIcon(slug) {
  const icons = {
    'flower': 'üåø',
    'pre-rolls': 'üö¨',
    'vaporizers': 'üí®',
    'concentrates': 'üçØ',
    'edibles': 'üç≠',
    'topicals': 'üß¥',
    'cartridges': 'üñäÔ∏è',
    'tinctures': 'üíß',
    'accessories': 'üîß',
    'cbd': 'üå±'
  };
  return icons[slug] || 'üåø';
}

// Category color mapping for variety
function getCategoryColor(index) {
  const colors = [
    'from-green-500 to-green-600',
    'from-yellow-400 to-yellow-500',
    'from-green-600 to-green-700',
    'from-yellow-500 to-yellow-600',
    'from-green-400 to-green-500',
    'from-yellow-300 to-yellow-400'
  ];
  return colors[index % colors.length];
}

try {
  console.log('üöÄ Fetching product categories from Railway API');

  const response = await fetch(`${API_BASE}/categories?populate=*&pagination[pageSize]=100&sort=Name:asc`);

  if (response.ok) {
    const data = await response.json();
    categoriesData = data?.data || [];
    console.log('‚úÖ Categories loaded:', categoriesData.length);
  } else {
    const errorData = await response.json();
    console.error('‚ùå Categories API Error:', errorData);
    apiError = errorData.error?.message || 'Failed to fetch categories';
  }
} catch (error) {
  console.error('‚ùå Error fetching categories:', error);
  apiError = error.message;
}

// Process categories for display
const categories = categoriesData.map((category, index) => {
  // Check if it's Strapi v4 format (with attributes) or direct format
  const isV4 = !!category.attributes;
  const data = isV4 ? category.attributes : category;

  return {
    id: category.id,
    documentId: category.documentId,
    name: data.Name || data.name || 'Unnamed Category',
    description: data.Description || data.description || '',
    slug: data.Slug || data.slug || category.documentId || category.id,
    icon: getCategoryIcon(data.Slug || data.slug),
    image: data.Image?.data?.attributes?.url
      ? `https://mintdealsbackend-production.up.railway.app${data.Image.data.attributes.url}`
      : data.image?.url
        ? `https://mintdealsbackend-production.up.railway.app${data.image.url}`
        : null,
    isActive: data.IsActive !== false && data.isActive !== false,
    colorGradient: getCategoryColor(index),
    productCount: data.products?.data?.length || data.products?.length || 0
  };
}).filter(category => category.name && category.isActive);

// Calculate statistics
const totalCategories = categories.length;
const totalProducts = categories.reduce((sum, cat) => sum + cat.productCount, 0);
const popularCategories = categories.sort((a, b) => b.productCount - a.productCount).slice(0, 3);
---

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tenor+Sans&display=swap');

  body {
    margin: 0;
    padding: 0;
    font-family: 'Tenor Sans', serif;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top, #29a329, #33cc33, #5cd65c, #85e085, #c2f0c2, #ebfaeb, #ffffff, #ffffff);
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.7));
  }
  .hero-section {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .category-card {
    transition: all 0.3s ease;
    transform: translateY(0);
  }
  .category-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<Layout title="Product Categories - FLMintDeals" description="Explore our comprehensive range of cannabis product categories">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="hero-section text-white">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        <div class="text-center">
          <div class="mb-4 flex justify-center">
            <img
              src="/assets/Mint_Full_Logo.png"
              alt="Mint Cannabis"
              class="h-20 md:h-24 lg:h-28 drop-shadow-2xl"
            />
          </div>
          <h1 class="mb-6 text-4xl font-bold md:text-5xl text-white drop-shadow-2xl" style="font-family: 'Tenor Sans', serif;">
            Product Categories
          </h1>
          <p class="max-w-3xl mx-auto mb-8 text-xl md:text-2xl text-yellow-400 drop-shadow-lg">
            Discover our complete selection of premium cannabis products
          </p>
        </div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="py-12 bg-black bg-opacity-90">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
          <div class="p-6 bg-gradient-to-r from-green-900 to-black rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">{totalCategories}</div>
            <div class="text-green-300 text-lg">Total Categories</div>
          </div>
          <div class="p-6 bg-gradient-to-r from-black to-green-900 rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">{totalProducts}</div>
            <div class="text-green-300 text-lg">Products Available</div>
          </div>
          <div class="p-6 bg-gradient-to-r from-green-900 to-black rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">100%</div>
            <div class="text-green-300 text-lg">Lab Tested</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Categories Grid -->
    <div class="py-16 bg-gradient-to-b from-black to-green-900">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">
            Browse All Categories
          </h2>
          <p class="text-xl text-green-300">
            Click on any category to explore products
          </p>
        </div>

        {apiError ? (
          <div class="text-center py-12">
            <div class="max-w-md p-8 mx-auto rounded-lg bg-red-900 bg-opacity-80">
              <div class="mb-4 text-6xl text-red-400">‚ö†Ô∏è</div>
              <h3 class="mb-2 text-lg font-medium text-red-200">API Error</h3>
              <p class="text-sm text-red-300">{apiError}</p>
            </div>
          </div>
        ) : categories.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {categories.map((category, index) => (
              <a
                href={`/${category.slug}`}
                class="category-card group block"
              >
                <div class="bg-black border-2 border-green-500 rounded-xl overflow-hidden hover:border-yellow-400 transition-all">
                  {/* Category Image */}
                  {category.image ? (
                    <div class="h-48 overflow-hidden bg-gradient-to-br from-green-900 to-black">
                      <img
                        src={category.image}
                        alt={category.name}
                        class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                      />
                    </div>
                  ) : (
                    <div class={`h-48 bg-gradient-to-br ${category.colorGradient} flex items-center justify-center`}>
                      <span class="text-6xl">{category.icon}</span>
                    </div>
                  )}

                  {/* Category Content */}
                  <div class="p-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-2 group-hover:text-yellow-300">
                      {category.name}
                    </h3>
                    {category.description && (
                      <p class="text-green-300 text-sm mb-3 line-clamp-2">
                        {category.description}
                      </p>
                    )}
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-green-400">
                        {category.productCount} products
                      </span>
                      <span class="text-yellow-400 group-hover:translate-x-2 transition-transform">
                        ‚Üí
                      </span>
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <div class="max-w-md p-8 mx-auto bg-black border-2 border-green-500 rounded-lg">
              <div class="mb-4 text-6xl">üåø</div>
              <h3 class="mb-2 text-lg font-medium text-yellow-400">No Categories Available</h3>
              <p class="text-green-300">Check back soon for our product categories.</p>
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Popular Categories Section -->
    {popularCategories.length > 0 && (
      <div class="py-16 bg-black bg-opacity-90">
        <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
          <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">
              Most Popular
            </h2>
            <p class="text-xl text-green-300">
              Our top categories by product count
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {popularCategories.map((category, index) => (
              <a
                href={`/${category.slug}`}
                class="group relative overflow-hidden rounded-xl bg-gradient-to-br from-green-900 to-black p-8 border-2 border-yellow-400 hover:border-yellow-300 transition-all hover:scale-105"
              >
                <div class="absolute top-2 right-2 bg-yellow-400 text-black px-3 py-1 rounded-full text-sm font-bold">
                  #{index + 1}
                </div>
                <div class="text-5xl mb-4">{category.icon}</div>
                <h3 class="text-2xl font-bold text-yellow-400 mb-2">
                  {category.name}
                </h3>
                <p class="text-green-300 text-lg">
                  {category.productCount} products available
                </p>
              </a>
            ))}
          </div>
        </div>
      </div>
    )}

    <!-- CTA Section -->
    <div class="py-16 bg-gradient-to-b from-green-900 to-black">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-6">
          Need Help Choosing?
        </h2>
        <p class="text-xl text-green-300 mb-8 max-w-2xl mx-auto">
          Our knowledgeable staff can help you find the perfect products for your needs
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a
            href="/locations"
            class="px-8 py-3 text-lg font-semibold text-black bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg hover:from-yellow-500 hover:to-yellow-600 transition-all transform hover:scale-105 shadow-lg"
          >
            Find a Store
          </a>
          <a
            href="/dosing-guide"
            class="px-8 py-3 text-lg font-semibold text-yellow-400 transition-all border-2 border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-black transform hover:scale-105 shadow-lg"
          >
            Dosing Guide
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>