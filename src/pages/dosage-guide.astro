---
export const prerender = true;

import Layout from '../layouts/Layout.astro';
import { strapi } from '../lib/strapi';

// Initialize data
let dosageGuideData = null;
let dosageProductsData = [];
let apiError = null;
let dosageForms = [];

try {
  console.log('üöÄ Fetching dosage data from Strapi');

  // Fetch dosage guide (single type) and products (collection with all relations)
  const guideResponse = await fetch(`http://localhost:1337/api/dosage-guide?populate=*`);
  const productsResponse = await fetch(`http://localhost:1337/api/dosage-products?populate=*&pagination[pageSize]=1000`);

  if (guideResponse.ok) {
    const guideJson = await guideResponse.json();
    dosageGuideData = guideJson.data;
    console.log('‚úÖ Dosage Guide loaded:', dosageGuideData);
  } else {
    const errorData = await guideResponse.json();
    console.error('‚ùå Dosage Guide error:', errorData);
  }

  if (productsResponse.ok) {
    const productsJson = await productsResponse.json();
    dosageProductsData = productsJson.data || [];
    console.log('‚úÖ Dosage Products loaded:', dosageProductsData.length);
  } else {
    const errorData = await productsResponse.json();
    console.error('‚ùå Dosage Products error:', errorData);
  }

  // Check if dosage guide has the forms data
  if (dosageGuideData?.forms) {
    dosageForms = dosageGuideData.forms;
  } else if (dosageProductsData.length > 0) {
    // Group products by their dosage form
    console.log('Grouping products by dosage form:', dosageProductsData);

    const formsMap = new Map();

    dosageProductsData.forEach(product => {
      const form = product.dosing_form;
      const formName = form?.Name || 'Other';
      const formSlug = form?.Slug || 'other';

      if (!formsMap.has(formSlug)) {
        formsMap.set(formSlug, {
          title: formName,
          servingInfo: form?.Discription || form?.Description || '',
          hasCannabinoidsColumn: formName.toLowerCase().includes('oral') ||
                                  formName.toLowerCase().includes('sublingual') ||
                                  formName.toLowerCase().includes('edible'),
          products: []
        });
      }

      // Format ingredients
      const ingredients = product.ingredients?.map(ing => ing.Name).filter(Boolean).join(', ') ||
                         product.Discription ||
                         'See product label';

      // Format quantity
      const qty = product.Unit ?
        `${product.QuantityPerPKG || 1} ${product.Unit.Unit || ''}`.trim() :
        `${product.QuantityPerPKG || 1} per package`;

      // Get cannabinoids info
      const cannabinoids = product.cannabinoids_type?.Name || '';

      formsMap.get(formSlug).products.push({
        name: product.Name || '',
        qty: qty,
        cannabinoids: cannabinoids,
        ingredients: ingredients
      });
    });

    // Convert map to array and sort by form name
    dosageForms = Array.from(formsMap.values()).sort((a, b) => {
      // Sort order: Inhalation, Sublingual, Oral, Edibles, Others
      const order = ['inhalation', 'sublingual', 'oral', 'edible'];
      const aIndex = order.findIndex(o => a.title.toLowerCase().includes(o));
      const bIndex = order.findIndex(o => b.title.toLowerCase().includes(o));

      if (aIndex === -1 && bIndex === -1) return a.title.localeCompare(b.title);
      if (aIndex === -1) return 1;
      if (bIndex === -1) return -1;
      return aIndex - bIndex;
    });
  }

} catch (error) {
  console.error('‚ùå Error fetching dosage data:', error);
  apiError = error.message;
}

// Remove hardcoded data - only use Strapi data
/*
const dosageForms = [
  {
    title: "Inhalation",
    servingInfo: "Serving size for inhalants is a three (3) second inhale. Please note THC and CBD content will vary by strain. Please see the Patient label for testing results and consult your doctor on what is the right dose for you.",
    hasCannabinoidsColumn: false,
    products: [
      { name: "Rosin Sauce", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Fresh Press Rosin", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Cold Cure Rosin", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Bubble Hash", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Live Bubble Hash", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Crumble", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Kief", qty: "1 Gram", ingredients: "Cannabis Pollen" },
      { name: "Shatter", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "Distillate Vape", qty: "0.5 Gram", ingredients: "Cannabis Oil, Terpenes" },
      { name: "Distillate Vape", qty: "1 Gram", ingredients: "Cannabis Oil, Terpenes" },
      { name: "Rosin Vape", qty: "0.5 Gram", ingredients: "Cannabis Oil" },
      { name: "Rosin Vape", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "All in One - Distillate", qty: "1 Gram", ingredients: "Cannabis Oil, Terpenes" },
      { name: "All in One - Distillate", qty: "2 Grams", ingredients: "Cannabis Oil, Terpenes" },
      { name: "All in One - Live Rosin", qty: "1 Gram", ingredients: "Cannabis Oil" },
      { name: "All in One - Live Rosin", qty: "2 Grams", ingredients: "Cannabis Oil" },
      { name: "Whole Flower", qty: "3.5g, 7g, 14g, 28g", ingredients: "Cannabis Flower" },
      { name: "Ground Flower", qty: "3.5g, 7g, 14g, 28g", ingredients: "Cannabis Flower" },
      { name: "Preroll", qty: "1g", ingredients: "Cannabis Flower" },
      { name: "Preroll", qty: "0.5g - 3pk", ingredients: "Cannabis Flower" },
      { name: "Preroll", qty: "0.5g - 20pk", ingredients: "Cannabis Flower" }
    ]
  },
  {
    title: "Sublingual",
    servingInfo: "Serving Size: Enclosed dropper is marked at 0.25mL increments. The maximum amount the dropper can hold is 1mL. The recommended serving size is 0.5mL. Please use as directed and determine with your doctor if the directed serving size is right for you.",
    hasCannabinoidsColumn: true,
    products: [
      {
        name: "Tincture 20:1",
        qty: "15mL Per Bottle",
        cannabinoids: "10mg THC + 0.5mg CBD",
        ingredients: "Cannabis Oil, Fractionated Coconut Oil (MCT), Terpenes"
      },
      {
        name: "Tincture 1:1",
        qty: "15mL Per Bottle",
        cannabinoids: "5mg THC + 5mg CBD",
        ingredients: "Cannabis Oil, Fractionated Coconut Oil (MCT), Terpenes"
      },
      {
        name: "Tincture Extra Strength",
        qty: "15mL Per Bottle",
        cannabinoids: "20mg THC",
        ingredients: "Cannabis Oil, Fractionated Coconut Oil (MCT), Terpenes"
      }
    ]
  },
  {
    title: "Oral",
    servingInfo: "The serving size is one (1) capsule. Please use as directed and determine with your doctor if the directed serving size is right for you.",
    hasCannabinoidsColumn: true,
    products: [
      {
        name: "THC Capsules",
        qty: "30 Capsules",
        cannabinoids: "10mg THC\n25mg THC\n50mg THC",
        ingredients: "Cannabis Oil, Medium Chain Triglycerides, HPMC Capsules"
      },
      {
        name: "RSO THC Capsules",
        qty: "30 Capsules",
        cannabinoids: "10mg RSO THC\n25mg RSO THC\n50mg RSO THC",
        ingredients: "Cannabis Oil, Medium Chain Triglycerides, HPMC Capsules"
      },
      {
        name: "CBD Capsules",
        qty: "30 Capsules",
        cannabinoids: "1mg THC + 10mg CBD\n10mg CBD\n25mg CBD\n50mg CBD",
        ingredients: "Cannabis Oil, Medium Chain Triglycerides, HPMC Capsules"
      },
      {
        name: "RSO CBD Capsules",
        qty: "30 Capsules",
        cannabinoids: "10mg RSO CBD\n25mg RSO CBD\n50mg RSO CBD",
        ingredients: "Cannabis Oil, Medium Chain Triglycerides, HPMC Capsules"
      }
    ]
  },
  {
    title: "Edibles",
    servingInfo: "Serving Size is one (1) piece or one (1) individually wrapped packet. Please use as directed and determine with your doctor if the directed serving size is right for you.",
    hasCannabinoidsColumn: true,
    products: [
      {
        name: "Soft Chews - Azuca",
        qty: "10 Chews",
        cannabinoids: "10mg per Chew",
        ingredients: "Corn Syrup, Sugar, Gelatin, Water, Sorbitol, Citric Acid, Cannabis Oil, Artificial Flavorings, Modified Food Starch, Gum, Carnauba Wax, Vegetable Oil."
      },
      {
        name: "Chocolate Drops - Azuca",
        qty: "10 Chocolate Drops",
        cannabinoids: "10mg per drop",
        ingredients: "Chocolate, Azuca TiME INFUSION Sugar, Distillate Cannabis Oil, Coconut Oil."
      },
      {
        name: "Chocolate Drops - RSO",
        qty: "10 Chocolate Drops",
        cannabinoids: "10mg per drop",
        ingredients: "Chocolate, Coconut Oil, RSO, Flavoring"
      },
      {
        name: "Soft chews - Rosin",
        qty: "10 Chews",
        cannabinoids: "10mg per Chew",
        ingredients: "Corn Syrup, Sugar, Gelatin, Water, Sorbitol, Citric Acid, Cannabis Oil, Artificial Flavorings, Modified Food Starch, Gum, Carnauba Wax, Vegetable Oil."
      },
      {
        name: "Soft chews - Distillate",
        qty: "10 Chews",
        cannabinoids: "10mg per Chew",
        ingredients: "Corn Syrup, Sugar, Gelatin, Water, Sorbitol, Citric Acid, Cannabis Oil, Artificial Flavorings, Modified Food Starch, Gum, Carnauba Wax, Vegetable Oil."
      },
      {
        name: "Soft chews - RSO",
        qty: "10 Chews",
        cannabinoids: "10mg per Chew",
        ingredients: "Corn Syrup, Sugar, Gelatin, Water, Sorbitol, Citric Acid, Cannabis Oil, Artificial Flavorings, Modified Food Starch, Gum, Carnauba Wax, Vegetable Oil."
      },
      {
        name: "Dissolvable Drink Powder",
        qty: "10 mg per individually dosed packet",
        cannabinoids: "",
        ingredients: "Sugar, Azuca TiME INFUSION (a proprietary blend of modified food starches and gums), Cannabis Oil."
      },
      {
        name: "Lozenges",
        qty: "10mg per lozenge",
        cannabinoids: "",
        ingredients: "Isomalt, Maltitol Syrup, Sucralose, Acesulfame Potassium, Malic Acid, Cannabis Oil, Citric Acid, Water, Flavoring"
      }
    ]
  }
];
*/
---

<Layout title="Cannabis Dosage Guide - FLMintDeals" description="Comprehensive dosage guide for cannabis products including inhalation, oral, sublingual, and edible forms with ingredients and serving sizes.">
  <!-- Hero Section -->
  <div class="bg-gradient-to-br from-green-800 via-green-700 to-emerald-700 text-white py-16">
    <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4">
          Cannabis Dosage Guide
        </h1>
        <p class="text-xl lg:text-2xl text-green-100 max-w-3xl mx-auto">
          Professional medical cannabis dosage information and product specifications
        </p>
      </div>
    </div>
  </div>

  <!-- Medical Disclaimer -->
  <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-6 my-8 mx-4 sm:mx-6 lg:mx-auto lg:max-w-7xl">
    <div class="flex items-start">
      <svg class="w-6 h-6 text-red-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
      </svg>
      <div>
        <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">Medical Disclaimer</h3>
        <p class="text-red-700 dark:text-red-300 text-sm">
          This information is for medical cannabis patients only. Always consult with your doctor to determine the appropriate dosage for your condition. Individual responses to cannabis may vary.
        </p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto py-12">
    {dosageForms.length === 0 ? (
      <div class="text-center py-16">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
        </svg>
        <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-100">No data found</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          {apiError ? `Error: ${apiError}` : 'No dosage guide data is available at this time.'}
        </p>
      </div>
    ) : (
      dosageForms.map(form => (
        <section class="mb-16">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <!-- Dosage Form Header -->
          <div class="border-b border-gray-200 dark:border-gray-700 pb-6 mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
              Dosage Form: {form.title}
            </h2>
            <p class="text-lg text-gray-700 dark:text-gray-300 leading-relaxed">
              {form.servingInfo}
            </p>
          </div>

          <!-- Products Table -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Product
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Qty per Package
                  </th>
                  {form.hasCannabinoidsColumn && (
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      Cannabinoids per Dose
                    </th>
                  )}
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Ingredients
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {form.products.map(product => (
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white align-top">
                      {product.name}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300 align-top">
                      {product.qty}
                    </td>
                    {form.hasCannabinoidsColumn && (
                      <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300 align-top">
                        <div class="whitespace-pre-line">
                          {product.cannabinoids || '-'}
                        </div>
                      </td>
                    )}
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300 align-top">
                      {product.ingredients}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    ))
    )}

    {dosageForms.length > 0 && (
    <>
    <!-- Additional Information Section -->
    <section class="mb-16">
      <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Important Information
        </h2>
        <div class="space-y-4 text-gray-700 dark:text-gray-300">
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>
              <strong>Individual Variation:</strong> Cannabis affects everyone differently. Start with the lowest recommended dose and gradually increase as needed.
            </p>
          </div>
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>
              <strong>Onset Times:</strong> Inhalation effects begin within minutes. Oral and edible products may take 30 minutes to 2 hours to take effect.
            </p>
          </div>
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>
              <strong>Duration:</strong> Inhalation effects typically last 1-3 hours. Oral and edible effects may last 4-8 hours or longer.
            </p>
          </div>
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>
              <strong>Storage:</strong> Store all cannabis products in a cool, dry place away from children and pets.
            </p>
          </div>
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>
              <strong>Medical Use Only:</strong> These products are intended for qualified medical cannabis patients only. Keep your medical recommendation current.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Contact Information -->
    <section>
      <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-8 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Questions About Dosing?
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          Consult with your recommending physician or speak with a knowledgeable budtender at any of our locations.
        </p>
        <a href="/stores" class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
          Find a Location Near You
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </section>
    </>
    )}
  </div>
</Layout>

<style>
  /* Table responsive styles */
  @media (max-width: 640px) {
    table {
      font-size: 0.875rem;
    }

    th, td {
      padding: 0.5rem;
    }
  }

  /* Multi-line text in table cells */
  .whitespace-pre-line {
    white-space: pre-line;
  }
</style>