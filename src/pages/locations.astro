---
import Layout from '../layouts/Layout.astro';

// Fetch stores/locations from Railway API
let storesData = [];
let statsData = {
  totalStores: 0,
  totalStates: 0,
  totalCities: 0,
  stateGroups: {}
};
let apiError = null;

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

try {
  console.log('üöÄ Fetching stores from Railway API');

  const response = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=100`);

  if (response.ok) {
    const data = await response.json();
    storesData = data?.data || [];
    console.log('‚úÖ Stores loaded:', storesData.length);
  } else {
    console.log('‚ö†Ô∏è Locations API not available, using fallback data');
    // Fallback data when API endpoint doesn't exist yet
    storesData = [
      {
        id: 1,
        documentId: 'mint-cannabis-tempe',
        attributes: {
          Name: 'Mint Cannabis - Tempe',
          Slug: 'mint-cannabis-tempe',
          Address: {
            street: '1234 Mill Avenue',
            city: 'Tempe',
            state: 'AZ',
            zipCode: '85281'
          },
          Phone: '(480) 555-0123',
          Hours: [
            { dayOfWeek: 'Monday-Friday', openTime: '9:00 AM', closeTime: '10:00 PM', isClosed: false },
            { dayOfWeek: 'Saturday-Sunday', openTime: '10:00 AM', closeTime: '9:00 PM', isClosed: false }
          ],
          LocationCode: 'TEMP01',
          Menu_url: 'https://mintcannabis.com/menu/tempe',
          over18: true,
          over21: true
        }
      },
      {
        id: 2,
        documentId: 'mint-cannabis-phoenix',
        attributes: {
          Name: 'Mint Cannabis - Phoenix',
          Slug: 'mint-cannabis-phoenix',
          Address: {
            street: '5678 Central Avenue',
            city: 'Phoenix',
            state: 'AZ',
            zipCode: '85012'
          },
          Phone: '(602) 555-0124',
          Hours: [
            { dayOfWeek: 'Monday-Friday', openTime: '8:00 AM', closeTime: '11:00 PM', isClosed: false },
            { dayOfWeek: 'Saturday-Sunday', openTime: '9:00 AM', closeTime: '10:00 PM', isClosed: false }
          ],
          LocationCode: 'PHX01',
          Menu_url: 'https://mintcannabis.com/menu/phoenix',
          over18: true,
          over21: true
        }
      },
      {
        id: 3,
        documentId: 'mint-cannabis-las-vegas',
        attributes: {
          Name: 'Mint Cannabis - Las Vegas',
          Slug: 'mint-cannabis-las-vegas',
          Address: {
            street: '9012 Las Vegas Boulevard',
            city: 'Las Vegas',
            state: 'NV',
            zipCode: '89123'
          },
          Phone: '(702) 555-0125',
          Hours: [
            { dayOfWeek: 'Daily', openTime: '24 Hours', closeTime: '', is_24hour: true, isClosed: false }
          ],
          LocationCode: 'LV01',
          Menu_url: 'https://mintcannabis.com/menu/las-vegas',
          over18: true,
          over21: true
        }
      }
    ];
    console.log('‚úÖ Fallback stores loaded:', storesData.length);
  }

  // Build statistics
  statsData.totalStores = storesData.length;
  const states = new Set();
  const cities = new Set();

  storesData.forEach(store => {
    // Use direct format from Railway API
    if (store.state) {
      const state = store.state?.toUpperCase();
      const city = store.city;

      states.add(state);
      if (city) cities.add(`${state}-${city}`);

      if (!statsData.stateGroups[state]) {
        statsData.stateGroups[state] = {
          name: state === 'AZ' ? 'Arizona' : state === 'NV' ? 'Nevada' : state,
          count: 0,
          cities: new Set()
        };
      }
      statsData.stateGroups[state].count++;
      if (city) statsData.stateGroups[state].cities.add(city);
    }
  });

  statsData.totalStates = states.size;
  statsData.totalCities = cities.size;

} catch (error) {
  console.error('‚ùå Error fetching data:', error);
  apiError = error.message;
}

// Process stores for display
const stores = storesData.map(store => {
  return {
    id: store.id,
    documentId: store.documentId,
    name: store.name || 'Unnamed Store',
    slug: store.slug || store.documentId,
    address: {
      street: store.address,
      city: store.city,
      state: store.state,
      zipCode: store.zip_code
    },
    phone: store.phone,
    hours: store.hours || [],
    image: store.image?.url
      ? `https://mintdealsbackend-production.up.railway.app${store.image.url}`
      : null,
    isActive: store.is_active !== false,
    menuUrl: store.menu_url,
    locationCode: store.location_code,
    productCategories: store.product_categories || [],
    over18: store.over18,
    over21: store.over21,
    latitude: store.latitude,
    longitude: store.longitude
  };
}).filter(store => store.isActive);
---

<style>
  @import url('https://fonts.googleapis.com/css2?family=Tenor+Sans&display=swap');

  body {
    margin: 0;
    padding: 0;
    font-family: 'Tenor Sans', serif;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top, #29a329, #33cc33, #5cd65c, #85e085, #c2f0c2, #ebfaeb, #ffffff, #ffffff);
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.7));
  }
  .hero-section {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .store-card {
    transition: all 0.3s ease;
    transform: translateY(0);
  }
  .store-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  }
</style>

<Layout title="Store Locations - Mint Cannabis" description="Find cannabis dispensary locations near you">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="hero-section text-white">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        <div class="text-center">
          <div class="mb-4 flex justify-center">
            <img
              src="/assets/Mint_Full_Logo.png"
              alt="Mint Cannabis"
              class="h-20 md:h-24 lg:h-28 drop-shadow-2xl"
            />
          </div>
          <h1 class="mb-6 text-4xl font-bold md:text-5xl text-white drop-shadow-2xl" style="font-family: 'Tenor Sans', serif;">
            Store Locations
          </h1>
          <p class="max-w-3xl mx-auto mb-8 text-xl md:text-2xl text-yellow-400 drop-shadow-lg" style="font-family: 'Tenor Sans', serif;">
            Find cannabis dispensaries and retailers near you
          </p>
        </div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="py-12 bg-black bg-opacity-90">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
          <div class="p-6 bg-gradient-to-r from-green-900 to-black rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">{statsData.totalStores}</div>
            <div class="text-green-300 text-lg">Total Dispensaries</div>
          </div>
          <div class="p-6 bg-gradient-to-r from-black to-green-900 rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">{statsData.totalStates}</div>
            <div class="text-green-300 text-lg">States Served</div>
          </div>
          <div class="p-6 bg-gradient-to-r from-green-900 to-black rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">{statsData.totalCities}</div>
            <div class="text-green-300 text-lg">Cities</div>
          </div>
          <div class="p-6 bg-gradient-to-r from-black to-green-900 rounded-lg border border-green-500">
            <div class="text-4xl font-bold text-yellow-400 mb-2">100%</div>
            <div class="text-green-300 text-lg">Licensed</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="py-16 bg-gradient-to-b from-black to-green-900">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl">
        {apiError ? (
          <div class="text-center py-16">
            <div class="max-w-md p-8 mx-auto rounded-lg bg-red-900 bg-opacity-80">
              <div class="mb-4 text-6xl text-red-400">‚ö†Ô∏è</div>
              <h3 class="mb-2 text-lg font-medium text-red-200">API Error</h3>
              <p class="text-sm text-red-300">{apiError}</p>
            </div>
          </div>
        ) : stores.length === 0 ? (
          <div class="text-center py-16">
            <div class="max-w-md p-8 mx-auto bg-black border-2 border-green-500 rounded-lg">
              <svg class="mx-auto h-12 w-12 text-yellow-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <h3 class="mb-2 text-lg font-medium text-yellow-400">No Locations Available</h3>
              <p class="text-green-300">Location information will be displayed here.</p>
            </div>
          </div>
        ) : (
          <div>
            {/* State Groups */}
            {Object.entries(statsData.stateGroups).map(([stateCode, stateGroup]) => (
              <div class="mb-12">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-bold text-yellow-400" style="font-family: 'Tenor Sans', serif;">
                    {stateGroup.name}
                  </h2>
                  <span class="bg-green-900 border border-green-500 text-yellow-400 px-4 py-2 rounded-full text-sm font-medium">
                    {stateGroup.count} dispensar{stateGroup.count !== 1 ? 'ies' : 'y'}
                  </span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {stores
                    .filter(store => {
                      const address = store.address;
                      return address?.state?.toUpperCase() === stateCode;
                    })
                    .map(store => (
                      <div class="store-card group">
                        <div class="bg-black border-2 border-green-500 rounded-xl overflow-hidden hover:border-yellow-400 transition-all">
                          {/* Store Image */}
                          {store.image && (
                            <div class="h-48 overflow-hidden bg-gradient-to-br from-green-900 to-black">
                              <img
                                src={store.image}
                                alt={store.name}
                                class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                              />
                            </div>
                          )}

                          <div class="p-6">
                            <h3 class="text-xl font-bold text-yellow-400 mb-2 group-hover:text-yellow-300">
                              {store.name}
                            </h3>

                            {/* Location Code */}
                            {store.locationCode && (
                              <span class="inline-block bg-green-900 border border-green-500 text-green-300 px-2 py-1 rounded text-xs font-medium mb-2">
                                {store.locationCode}
                              </span>
                            )}

                            {/* Address */}
                            {store.address && (
                              <p class="text-green-300 mb-2 flex items-start">
                                <svg class="w-5 h-5 mr-2 mt-0.5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                {store.address.street}, {store.address.city}, {store.address.state} {store.address.zipCode}
                              </p>
                            )}

                            {/* Phone */}
                            {store.phone && (
                              <p class="text-green-300 mb-2 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                <a href={`tel:${store.phone}`} class="hover:text-yellow-400 transition-colors">
                                  {store.phone}
                                </a>
                              </p>
                            )}

                            {/* Hours */}
                            {store.hours && store.hours.length > 0 && (
                              <div class="mb-3">
                                <div class="flex items-center text-green-300 mb-1">
                                  <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                  </svg>
                                  <span class="text-sm font-medium">Hours:</span>
                                </div>
                                {store.hours.slice(0, 2).map(hour => (
                                  <div class="text-sm text-green-400 ml-7">
                                    {hour.dayOfWeek && (
                                      <span class="capitalize">{hour.dayOfWeek}: </span>
                                    )}
                                    {hour.is_24hour ?
                                      '24 Hours' :
                                      hour.isClosed ?
                                        'Closed' :
                                        `${hour.openTime || ''} - ${hour.closeTime || ''}`
                                    }
                                  </div>
                                ))}
                                {store.hours.length > 2 && (
                                  <div class="text-xs text-green-500 ml-7">+{store.hours.length - 2} more</div>
                                )}
                              </div>
                            )}

                            {/* Product Categories */}
                            {store.productCategories && store.productCategories.length > 0 && (
                              <div class="mb-4">
                                <div class="flex flex-wrap gap-1">
                                  {store.productCategories.slice(0, 3).map(category => (
                                    <span class="inline-block bg-green-900 border border-green-600 text-green-300 px-2 py-1 rounded text-xs">
                                      {category.Name || category.name}
                                    </span>
                                  ))}
                                  {store.productCategories.length > 3 && (
                                    <span class="inline-block bg-black border border-green-600 text-green-400 px-2 py-1 rounded text-xs">
                                      +{store.productCategories.length - 3} more
                                    </span>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Status and Age Requirements */}
                            <div class="flex items-center justify-between mb-4">
                              <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-green-900 border border-green-500 text-green-300">
                                Open
                              </span>

                              <div class="flex space-x-1">
                                {store.over18 && (
                                  <span class="inline-block bg-yellow-900 border border-yellow-600 text-yellow-300 px-2 py-1 rounded text-xs">
                                    18+
                                  </span>
                                )}
                                {store.over21 && (
                                  <span class="inline-block bg-red-900 border border-red-600 text-red-300 px-2 py-1 rounded text-xs">
                                    21+
                                  </span>
                                )}
                              </div>
                            </div>

                            {/* Action Buttons */}
                            <div class="flex space-x-2">
                              {store.slug && (
                                <a
                                  href={`/location/${store.slug}`}
                                  class="flex-1 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-black px-4 py-2 rounded-lg text-center font-medium transition-all transform hover:scale-105"
                                >
                                  View Store
                                </a>
                              )}

                              {store.menuUrl && (
                                <a
                                  href={store.menuUrl}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-center font-medium transition-all transform hover:scale-105"
                                >
                                  Menu
                                </a>
                              )}

                              {store.address && (
                                <a
                                  href={`https://maps.google.com/?q=${encodeURIComponent(`${store.address.street}, ${store.address.city}, ${store.address.state}`)}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all transform hover:scale-105"
                                >
                                  Directions
                                </a>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>

    <!-- CTA Section -->
    <div class="py-16 bg-black bg-opacity-90">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-7xl text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-6" style="font-family: 'Tenor Sans', serif;">
          Can't Find What You're Looking For?
        </h2>
        <p class="text-xl text-green-300 mb-8 max-w-2xl mx-auto">
          Contact us to learn about new locations or special product availability
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a
            href="/categories"
            class="px-8 py-3 text-lg font-semibold text-black bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg hover:from-yellow-500 hover:to-yellow-600 transition-all transform hover:scale-105 shadow-lg"
          >
            Browse Products
          </a>
          <a
            href="/dosing-guide"
            class="px-8 py-3 text-lg font-semibold text-yellow-400 transition-all border-2 border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-black transform hover:scale-105 shadow-lg"
          >
            Dosing Guide
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>