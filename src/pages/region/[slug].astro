---
import Layout from '../../layouts/Layout.astro';

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

export async function getStaticPaths() {
  try {
    const response = await fetch(`${API_BASE}/regions?populate=*`);
    const data = await response.json();

    if (data?.data && Array.isArray(data.data)) {
      return data.data.map((region: any) => ({
        params: {
          slug: region.slug || (region.name ? region.name.toLowerCase().replace(/\s+/g, '-') : region.documentId)
        },
        props: { region }
      }));
    }
  } catch (error) {
    console.error('Error fetching regions:', error);
  }

  // Fallback
  return [{ params: { slug: 'test-region' } }];
}

const { region } = Astro.props;
const { slug } = Astro.params;

// Fetch stores for this region if region prop is available
let stores: any[] = [];
if (region) {
  try {
    const response = await fetch(`${API_BASE}/stores?filters[region][id][$eq]=${region.id}&populate=*&pagination[pageSize]=100`);
    if (response.ok) {
      const data = await response.json();
      stores = data?.data || [];
    }
  } catch (error) {
    console.error('Error fetching stores:', error);
  }
}

const regionName = region?.name || slug.replace(/-/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());
---

<Layout title={`${regionName} - Store Locations`} description={`Find Mint Cannabis dispensaries in ${regionName}`}>
  <div class="max-w-7xl mx-auto px-4 py-16">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">
      üìç {regionName}
    </h1>
    {region?.description && (
      <p class="text-lg text-gray-600 mb-8">
        {region.description}
      </p>
    )}

    {stores.length > 0 ? (
      <div>
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
          {stores.length} Location{stores.length !== 1 ? 's' : ''} in {regionName}
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {stores.map((store: any) => (
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
              <h3 class="text-xl font-semibold text-gray-900 mb-2">
                {store.name}
              </h3>
              <p class="text-gray-600 text-sm mb-4">
                {store.city}, {store.state}
              </p>
              <a
                href={`/location/${store.slug}`}
                class="inline-block bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
              >
                View Store
              </a>
            </div>
          ))}
        </div>
      </div>
    ) : (
      <p class="text-gray-600">
        No stores found in this region yet.
      </p>
    )}
  </div>
</Layout>
